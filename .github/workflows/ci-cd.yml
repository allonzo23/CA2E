name: CI/CD Pipeline CA2E

on:
  push:
    branches: 
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: üì• Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Docker Buildx
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3Ô∏è‚É£ Docker login to Docker Hub
      - name: üîê Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4Ô∏è‚É£ Build & Push Backend (avec cache optimis√©)
      - name: üî® Build and Push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./mon_backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ca2e-backend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ca2e-backend:latest
          cache-to: type=inline

      # 5Ô∏è‚É£ Build & Push Frontend (avec cache optimis√©)
      - name: üé® Build and Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./mon_frontend_react
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ca2e-frontend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/ca2e-frontend:latest
          cache-to: type=inline

      # 6Ô∏è‚É£ Deploy on VPS
      - name: üöÄ Deploy to VPS
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            cd /home/yhas/CA2E

            echo "üìä ===== DISK SPACE BEFORE CLEANUP ====="
            df -h / | tail -1 | awk '{print "üíæ Disk usage: " $3 " used / " $2 " total (" $5 " full)"}'
            echo "üóÇÔ∏è  Docker images before: $(docker images | wc -l)"

            echo ""
            echo "üõë Stopping containers..."
            docker compose down --remove-orphans
            docker compose -f docker-compose.monitoring.yml down 2>/dev/null || true

            echo ""
            echo "üßπ ===== CLEANING OLD DOCKER DATA ====="
            
            # Supprime les images de plus de 48h
            echo "üóëÔ∏è  Removing images older than 48 hours..."
            docker image prune -a -f --filter "until=48h"
            
            # Supprime les volumes non utilis√©s
            echo "üóëÔ∏è  Removing unused volumes..."
            docker volume prune -f
            
            # Supprime les r√©seaux non utilis√©s
            echo "üóëÔ∏è  Removing unused networks..."
            docker network prune -f
            
            # Supprime les conteneurs arr√™t√©s
            echo "üóëÔ∏è  Removing stopped containers..."
            docker container prune -f

            echo ""
            echo "üìä ===== DISK SPACE AFTER CLEANUP ====="
            df -h / | tail -1 | awk '{print "üíæ Disk usage: " $3 " used / " $2 " total (" $5 " full)"}'
            echo "üóÇÔ∏è  Docker images after: $(docker images | wc -l)"
            echo "üéØ Dangling images: $(docker images -f 'dangling=true' -q | wc -l)"

            echo ""
            echo "‚¨áÔ∏è  Pulling new images from Docker Hub..."
            docker compose pull

            echo ""
            echo "üöÄ Starting application containers..."
            docker compose up -d --remove-orphans

            echo ""
            echo "üìä Starting monitoring stack..."
            if [ -f docker-compose.monitoring.yml ]; then
              docker compose -f docker-compose.monitoring.yml up -d
              echo "‚úÖ Monitoring started successfully"
            else
              echo "‚ö†Ô∏è  docker-compose.monitoring.yml not found, skipping monitoring"
            fi

            echo ""
            echo "‚è≥ Waiting for containers to stabilize (15 seconds)..."
            sleep 15

            echo ""
            echo "üìå ===== CONTAINERS STATUS ====="
            docker compose ps
            
            echo ""
            echo "üìä ===== MONITORING STATUS ====="
            docker compose -f docker-compose.monitoring.yml ps 2>/dev/null || echo "‚ö†Ô∏è  No monitoring containers"
            
            echo ""
            echo "üåê ===== RUNNING CONTAINERS WITH PORTS ====="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | head -20
            
            echo ""
            echo "üîç ===== NETWORK DETAILS ====="
            docker network inspect ca2e_ca2e_network --format '{{range .Containers}}{{.Name}}: {{.IPv4Address}}{{println}}{{end}}' 2>/dev/null || echo "‚ö†Ô∏è  Network not found or empty"
            
            echo ""
            echo "üè• ===== HEALTH CHECK ====="
            
            # V√©rifie si les conteneurs principaux tournent
            BACKEND_STATUS=$(docker inspect -f '{{.State.Status}}' backend_ca2e 2>/dev/null || echo "not found")
            FRONTEND_STATUS=$(docker inspect -f '{{.State.Status}}' frontend_ca2e 2>/dev/null || echo "not found")
            POSTGRES_STATUS=$(docker inspect -f '{{.State.Status}}' postgres_ca2e 2>/dev/null || echo "not found")
            
            echo "Backend:  $BACKEND_STATUS"
            echo "Frontend: $FRONTEND_STATUS"
            echo "Postgres: $POSTGRES_STATUS"
            
            # Alerte si un service critique est down
            if [ "$BACKEND_STATUS" != "running" ] || [ "$FRONTEND_STATUS" != "running" ] || [ "$POSTGRES_STATUS" != "running" ]; then
              echo ""
              echo "‚ö†Ô∏è  WARNING: Some critical services are not running!"
              echo "Check logs with: docker logs <container_name>"
            fi

            echo ""
            echo "üìä ===== FINAL DISK USAGE ====="
            df -h / | tail -1 | awk '{
              if (substr($5, 1, length($5)-1) > 85) 
                print "üî¥ CRITICAL: Disk usage at " $5 " - Consider cleanup or expansion!"
              else if (substr($5, 1, length($5)-1) > 70)
                print "‚ö†Ô∏è  WARNING: Disk usage at " $5 " - Monitor closely"
              else
                print "‚úÖ OK: Disk usage at " $5
            }'
            
            echo ""
            echo "‚úÖ ===== DEPLOYMENT COMPLETE ====="
            echo "üåê Application:  http://${{ secrets.SERVER_HOST }}"
            echo "üìä Grafana:      http://${{ secrets.SERVER_HOST }}:3000 (admin/admin)"
            echo "üîß Portainer:    http://${{ secrets.SERVER_HOST }}:9000"
            echo "üìà Prometheus:   http://${{ secrets.SERVER_HOST }}:9090"
            echo ""
            echo "üí° Tips:"
            echo "  - Check logs: docker logs <container_name>"
            echo "  - Restart: docker compose restart <service_name>"
            echo "  - Manual cleanup: docker system prune -a -f"